## 客户端公开课大作业说明文档：

### 大作业完成思路概括：

分为三部分完成，第一部分为功能1 2 5 6，第二部分为功能3 4 7，第三部分为功能8 9 10

第一部分创建一个炮台，可有玩家操控并瞄准旋转，同时能够进行炮弹的发射

第二部分通过对ShooterGame的源码阅读了解demo的UI机制以及伤害判定机制，进行代码修改添加

第三部分主要通过UE引擎来实现AI、骨骼、动画的基本操作

#### 一、场景中创建一个炮台

声明定义一个继承于APawn的炮台AFort类，包含有基本的Skeletal Mesh Component等组件，并基于此生成蓝图BP_Fort（ /Game/Blueprints/BP_Fort ）。

#### 二、操控炮台左右旋转

在AFort类中添加UCameraComponent作为操控的镜头FollowCamera，绑定LookUp和Turn行为；再获得FollowCamera的引用并得到其Pitch、Yaw角度，通过炮台模型的调整和BlendSpace的使用，实现炮台随镜头的上下左右旋转（限制了可调节的角度范围）。

#### 三、击杀带动画效果UI（FadeOut）

在PlayerPawn原有的HeroTPP材质的基础上，将其修改为Masked类型的material，并通过TimeLine、Material Parameters Collection实现出FadeOut的材质效果；具体操作是通过在ShooterCharacter死亡后等待一段时间切换成HeroTPP_FadeOut材质（ /Game/Characters/Materials/Material_FadeOut/HeroTPP_FadeOut ）

#### 四、HUD FreeDrag功能

阅读demo源码后，了解其HUD的实现逻辑：通过对HUDMain等纹理的截取，在UCanvas的基础上指定位置实现纯手绘的UI界面，同时菜单界面的显示是在ShooterInGameMenu、ShooterOptions类中完成；于是先通过在菜单显示的代码里修改，得到在游戏内菜单里的FREE DRAG选项，以及其子菜单里的具体UI与返回选项，然后可通过Input触发按键响应后，相应的UI会跟随玩家鼠标的移动实现FreeDrag。（demo的HUD实现并非传统的UMG，可尝试仿照demo创建一个新的基于UMG实现的UI界面，能更方便地实现FreeDrag功能）

#### 五、炮弹抛物线飞行并爆炸

在AFort类中绑定OnFire行为后，编写生成炮弹的代码，通过对所选炮台模型的测量估计，进行数学计算得到炮弹生成的SpawnLocation、SpawnRotation，在计算得到的位置处生成炮弹实现发射效果（在AFort里添加了USceneComponent作为枪管位置辅助实现）；此处炮弹采用了demo中原有的ShooterProjectile类来实现，并可通过AShooterProjectile*的指针来调整生成的炮弹实例的重力、速度等效果。（同时通过ChildActor为玩家实现了切换为俯瞰视角）

#### 六、炮弹开火飞行爆炸特效

由于采用了demo原有的ShooterProjectile，炮弹已有飞行爆炸特效，开火特效通过在AFort中添加FActorSpawnParameters来在枪管位置生成粒子效果作为开火特效；可通过对ShooterProjectile的代码修改或对其蓝图类操作，进行特效的更换改变。

#### 七、操控炮台击杀双倍得分

demo中的伤害计算、击杀判定是基于UE完善的Instigator与Damage系统实现的，要实现双倍击杀功能首先得弄清楚demo的伤害来源设置，具体是在AShooterPlayerController控制AFort时，通过功能五中的指针来设置炮弹实例的Instigator、Owner、Controller来将炮弹击杀的Killer来源设置为玩家Controller，并通过简单的逻辑判定是否操控炮台，在ShooterGameMode类的Killed函数中实现双倍得分。

#### 八、导航网格寻路

Demo场景中已存在一个NavMeshBoundVolumn，可按P查看其生成的导航网格，寻路功能在功能9的NPC巡逻中实现

#### 九、NPC行为树（巡逻、视野、攻击）

声明定义了APatrolPath类，包含了USplineComponent，可通过创建其蓝图BP_PatrolPath，在蓝图中绘制各种想要的巡逻路线，最后可以在BotPawn实例中自由选择场景中的BP_PatrolPath作为NPC的巡逻路径；在AShooterBot中添加UAIPerceptionComponent，以及相应的UAISenseConfig_Sight作为视觉感知传感，可在BotPawn实例中设置NPC的视野半径；在UAIPerceptionComponent感知到PlayerPawn时，设置行为树的黑板中SenseEnemy，随后NPC会对玩家发起攻击。（具体可查看/Game/Blueprints/Pawns中相关实现行为树和添加的Task）。

#### 十、停步动作以及IK效果

停步动作表现在ShooterCharacter停下时的惯性表现，通过在相应的动画蓝图中的状态转换机中添加State：StartMove、StopMove，播放相应的起步停步动画实现（在Mixamo网站上下载的动画资源重定向获得）；在骨骼物理、逆向运动学的基础上，进行骨骼关节对地距离的计算处理，借助蓝图节点Two Bone IK，最后进行相应的偏移，实现出基本的IK效果。